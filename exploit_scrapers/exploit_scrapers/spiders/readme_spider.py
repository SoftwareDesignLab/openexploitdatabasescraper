# Name: parse_github_readme.py
# Author: Mark Rumsey
# Date: 05/26/23
# Description: parses https://raw.githubusercontent.com/nomi-sec/PoC-in-GitHub/master/README.md
# and creates CSV of github links to CVE exploits

from exploit_scrapers.exploit_scrapers.utils import save_exploit
from datetime import datetime
from time import sleep
#from git import Repo
import scrapy
import csv
import re


class ReadMeSpider(scrapy.Spider):
    name = "readme"
    start_urls = ["https://raw.githubusercontent.com/nomi-sec/PoC-in-GitHub/master/README.md"]

    def parse(self, response):
        
        for line in response.text.split('\n'):

            # parse file for CVE
            if line.startswith('###'):
                cve = re.search('CVE-\d*-\d*', line).group()

            # parse file for urls
            if line.startswith('-'):
                link = re.search('\(([^)]+)\)', line).group(1)
                # Create exploit model here and clone git repo
                save_exploit(source="github", cve, is_repo=True, author=link.split('/')[3])
                Repo.clone_from(link, "path/to/repos_dir/")
                sleep(5)