# Name: parse_github_readme.py
# Author: Mark Rumsey
# Date: 05/26/23
# Description: parses https://raw.githubusercontent.com/nomi-sec/PoC-in-GitHub/master/README.md
# and creates CSV of github links to CVE exploits

from datetime import datetime
import scrapy
import csv
import re


class ReadMeSpider(scrapy.Spider):
    name = "readme"
    start_urls = ["https://raw.githubusercontent.com/nomi-sec/PoC-in-GitHub/master/README.md"]

    def parse(self, response):
        # create file with timestamp
        now = str(datetime.now()).replace(' ', '_')
        outfile = open(f'readme_links_{now}.csv', 'w')
        writer = csv.writer(outfile)

        # write header to CSV
        header = ['CVE_id', 'url']
        writer.writerow(header)

        for line in response.text.split('\n'):

            # parse file for CVE
            if line.startswith('###'):
                cve = re.search('CVE-\d*-\d*', line).group()

            # parse file for urls
            if line.startswith('-'):
                link = re.search('\(([^)]+)\)', line).group(1)
                writer.writerow([cve, link])